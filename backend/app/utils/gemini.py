import os
import json
import openai
import re
from dotenv import load_dotenv
from fastapi import HTTPException

load_dotenv()

client = openai.AzureOpenAI(
    api_key=os.getenv("AZURE_OPENAI_API_KEY"),
    api_version="2024-02-15-preview",
    azure_endpoint=os.getenv("AZURE_OPENAI_ENDPOINT")
)

DEPLOYMENT_NAME = os.getenv("AZURE_OPENAI_DEPLOYMENT")  # –ù–∞–ø—Ä–∏–º–µ—Ä: "gpt-35-turbo"

def extract_json_from_response(text: str) -> dict:
    try:
        json_str = re.search(r"\{.*\}", text, re.DOTALL).group()
        return json.loads(json_str)
    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ JSON:", e)
        raise HTTPException(status_code=500, detail="OpenAI –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON")

def analyze_resume_with_openai(text: str) -> dict:
    prompt = f"""
–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ—Ç —Ä–µ–∑—é–º–µ –¥–ª—è HR-—Å–∏—Å—Ç–µ–º—ã. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –ø–æ–ª–µ–π. –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–º—É-—Ç–æ –ø–æ–ª—é –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ‚Äî –Ω–µ –≤–∫–ª—é—á–∞–π –µ–≥–æ –≤ JSON –≤–æ–æ–±—â–µ (–Ω–µ –ø–∏—à–∏ 'string', 'null', 'none', '0' –∏ —Ç.–ø.).

**–ü–æ–ª—è –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- full_name: –§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é, –µ—Å–ª–∏ –µ—Å—Ç—å.
- gender: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'male', 'female', '–∂–µ–Ω—Å–∫–∏–π', '–º—É–∂—Å–∫–æ–π').
- phone_number: –¢–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.
- email: –¢–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–π email, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.
- citizenship: –ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ.
- address: –ì–æ—Ä–æ–¥ –∏ —Å—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å.
- education: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –∫–ª—é—á–∞–º–∏: university, degree, cgpa, scholarship, start_date, end_date, relevant_courses (–µ—Å–ª–∏ –µ—Å—Ç—å).
- experience: –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∫–ª—é—á–∞–º–∏: title, company/organization, location, start_date, end_date, responsibilities, achievement (–µ—Å–ª–∏ –µ—Å—Ç—å).
- experience_level: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω (junior/middle/senior/lead –∏ —Ç.–ø.).
- skills: –°–ø–∏—Å–æ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ —Ç.–ø. (–Ω–∞–ø—Ä–∏–º–µ—Ä, ["Python", "SQL", "Django"]).
- languages: –°–ø–∏—Å–æ–∫ —è–∑—ã–∫–æ–≤ –∏ —É—Ä–æ–≤–Ω–µ–π –≤–ª–∞–¥–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å.
- interests: –°–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤, –µ—Å–ª–∏ –µ—Å—Ç—å.
- achievements: –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π, –Ω–∞–≥—Ä–∞–¥, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤, –ø—Ä–∏–∑–æ–≤—ã—Ö –º–µ—Å—Ç, –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∏ —Ç.–ø. –î–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–ø—ã—Ç–∞ –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤, –≤—ã–¥–µ–ª–∏ –∏—Ö —Å—é–¥–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ø–∏—Å–∫–æ–º.
- desired_position: –ñ–µ–ª–∞–µ–º–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞.
- desired_salary: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–∞ —Å—É–º–º–∞ –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω.
- desired_city: –ì–æ—Ä–æ–¥, –≤ –∫–æ—Ç–æ—Ä–æ–º –∏—â–µ—Ç —Ä–∞–±–æ—Ç—É, –µ—Å–ª–∏ –µ—Å—Ç—å.
- desired_format: –§–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã (–æ–Ω–ª–∞–π–Ω, –æ—Ñ–ª–∞–π–Ω, –≥–∏–±—Ä–∏–¥), –µ—Å–ª–∏ –µ—Å—Ç—å.
- desired_work_time: –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã (full-time, part-time –∏ —Ç.–ø.), –µ—Å–ª–∏ –µ—Å—Ç—å.
- industries: –°–ø–∏—Å–æ–∫ –∏–Ω–¥—É—Å—Ç—Ä–∏–π –∏–ª–∏ —Å—Ñ–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–π –ø–æ–ª–µ, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
- –ù–µ –ø–∏—à–∏ –º—É—Å–æ—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ('string', 'none', 'null', '0', 'N/A' –∏ —Ç.–ø.).
- –ï—Å–ª–∏ –ø–æ–ª–µ —Å–ª–æ–∂–Ω–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, education, experience, skills, achievements), –≤–µ—Ä–Ω–∏ –µ–≥–æ –∫–∞–∫ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–ª–∏ —Å–ø–∏—Å–æ–∫.
- –ï—Å–ª–∏ –≤ —Ä–µ–∑—é–º–µ –µ—Å—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (–Ω–∞–≥—Ä–∞–¥—ã, –ø—Ä–∏–∑–æ–≤—ã–µ –º–µ—Å—Ç–∞, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏ —Ç.–¥.), –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–¥–µ–ª–∏ –∏—Ö –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ achievements (—Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫), –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–ø—ã—Ç–∞ –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤.

**–ü—Ä–∏–º–µ—Ä:**
{{
  "full_name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  "email": "ivan@example.com",
  "phone_number": "+7 777 123 45 67",
  "education": {{
    "university": "–ú–ì–£",
    "degree": "–ë–∞–∫–∞–ª–∞–≤—Ä –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏",
    "cgpa": 4.8,
    "start_date": "2018",
    "end_date": "2022"
  }},
  "skills": ["Python", "SQL", "Django"],
  "experience": [
    {{
      "title": "Backend Developer",
      "company": "–û–û–û –†–æ–≥–∞ –∏ –ö–æ–ø—ã—Ç–∞",
      "location": "–ú–æ—Å–∫–≤–∞, –†–æ—Å—Å–∏—è",
      "start_date": "2022-06",
      "end_date": "2023-12",
      "responsibilities": ["–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ API", "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏"],
      "achievement": "–í–Ω–µ–¥—Ä–∏–ª CI/CD, —É—Å–∫–æ—Ä–∏–ª —Ä–µ–ª–∏–∑—ã –Ω–∞ 30%"
    }}
  ],
  "achievements": [
    "–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –æ–ª–∏–º–ø–∏–∞–¥—ã –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é",
    "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç AWS Certified Developer"
  ]
}}

–†–µ–∑—é–º–µ:
{text}
"""  # –¢–≤–æ–π –¥–ª–∏–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –æ—Å—Ç–∞–≤—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

    try:
        response = client.chat.completions.create(
            model=DEPLOYMENT_NAME,
            messages=[
                {"role": "system", "content": "–¢—ã —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ—à—å —Ä–µ–∑—é–º–µ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ —Å—Ç—Ä–æ–≥–æ –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É —à–∞–±–ª–æ–Ω—É."},
                {"role": "user", "content": prompt},
            ],
            temperature=0.2,
            max_tokens=2000,
        )
        raw_text = response.choices[0].message.content
        print("üì• –û—Ç–≤–µ—Ç –æ—Ç Azure OpenAI:", raw_text)
        return extract_json_from_response(raw_text)
    except Exception as e:
        print("‚ùå Azure OpenAI API error:", e)
        raise HTTPException(status_code=500, detail="–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Azure OpenAI API")

def recommend_jobs_with_openai(profile: dict, jobs: list) -> list:
    """
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Azure OpenAI –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω.
    –ù–∞ –≤—Ö–æ–¥–µ: profile (dict) ‚Äî –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, jobs (list) ‚Äî —Å–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π (dict).
    –ù–∞ –≤—ã—Ö–æ–¥–µ: —Å–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π —Å –ø—Ä–∏—á–∏–Ω–∞–º–∏ (list of dict: {job, reasons})
    """
    prompt = f"""
–¢—ã ‚Äî AI-—ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–æ–¥–±–æ—Ä—É –≤–∞–∫–∞–Ω—Å–∏–π. –¢–µ–±–µ –¥–∞–Ω –ü–û–õ–ù–´–ô –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–µ–∑—é–º–µ + –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è) –∏ —Å–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏.

–ê–ù–ê–õ–ò–ó–ò–†–£–ô –í–°–Æ –ò–ù–§–û–†–ú–ê–¶–ò–Æ –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï:

**–û–ü–´–¢ –ò –ù–ê–í–´–ö–ò (–≤—ã—Å–æ–∫–∏–π –≤–µ—Å):**
- skills: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏, —è–∑—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- experience: –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã, –ø—Ä–æ–µ–∫—Ç—ã, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
- experience_level: —É—Ä–æ–≤–µ–Ω—å (junior/middle/senior)
- education: –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, —Å—Ç–µ–ø–µ–Ω—å, —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç
- achievements: —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –Ω–∞–≥—Ä–∞–¥—ã, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

**–ñ–ï–õ–ê–ù–ò–Ø –ò –ü–†–ï–î–ü–û–ß–¢–ï–ù–ò–Ø (–≤—ã—Å–æ–∫–∏–π –≤–µ—Å):**
- desired_position: –∂–µ–ª–∞–µ–º–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å
- desired_city: –∂–µ–ª–∞–µ–º—ã–π –≥–æ—Ä–æ–¥
- desired_format: —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã (–æ–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω/–≥–∏–±—Ä–∏–¥)
- desired_work_time: –≥—Ä–∞—Ñ–∏–∫ (full-time/part-time)
- desired_salary: –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è
- industries: –∂–µ–ª–∞–µ–º—ã–µ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏

**–õ–ò–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø (–Ω–∏–∑–∫–∏–π –≤–µ—Å):**
- languages: –∑–Ω–∞–Ω–∏–µ —è–∑—ã–∫–æ–≤
- interests: –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ —Ö–æ–±–±–∏

–ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò:

üéØ **–ò–î–ï–ê–õ–¨–ù–û–ï –°–û–í–ü–ê–î–ï–ù–ò–ï (score: 5):**
- –ù–∞–≤—ã–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üî —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏ (80%+ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
- –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –≤–∞–∫–∞–Ω—Å–∏–∏
- –ñ–µ–ª–∞–µ–º–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å = –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏–ª–∏ –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ
- –£—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
- –ì–æ—Ä–æ–¥/—Ñ–æ—Ä–º–∞—Ç/–≥—Ä–∞—Ñ–∏–∫ —Å–æ–≤–ø–∞–¥–∞—é—Ç

‚≠ê **–û–¢–õ–ò–ß–ù–û–ï –°–û–í–ü–ê–î–ï–ù–ò–ï (score: 4):**
- –ù–∞–≤—ã–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç –Ω–∞ 60-80%
- –û–ø—ã—Ç —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω
- –î–æ–ª–∂–Ω–æ—Å—Ç—å –≤ —Ç–æ–π –∂–µ —Å—Ñ–µ—Ä–µ
- –£—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç (¬±1 —É—Ä–æ–≤–µ–Ω—å)
- 2+ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º

‚úÖ **–•–û–†–û–®–ï–ï –°–û–í–ü–ê–î–ï–ù–ò–ï (score: 3):**
- –ù–∞–≤—ã–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç –Ω–∞ 40-60%
- –ï—Å—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ–ø—ã—Ç –∏–ª–∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
- –î–æ–ª–∂–Ω–æ—Å—Ç—å –≤ —Å–º–µ–∂–Ω–æ–π —Å—Ñ–µ—Ä–µ
- 1-2 —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º

ü§î **–í–û–ó–ú–û–ñ–ù–û–ï –°–û–í–ü–ê–î–ï–ù–ò–ï (score: 2):**
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–≤—ã–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç (20-40%)
- –û–ø—ã—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏–º—ã–π –∏–ª–∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ
- –•–æ—Ç—è –±—ã 1 –≤–∞–∂–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ

‚ùå **–°–õ–ê–ë–û–ï –°–û–í–ü–ê–î–ï–ù–ò–ï (score: 1):**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –Ω–∞–≤—ã–∫–∞–º (<20%)
- –¢–æ–ª—å–∫–æ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–°–ï –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è, –Ω–µ —Ç–æ–ª—å–∫–æ desired_*
- –£—á–∏—Ç—ã–≤–∞–π —Å–∏–Ω–æ–Ω–∏–º—ã –∏ —Å–º–µ–∂–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (React ‚âà JavaScript, Python ‚âà Django)
- –°—Ä–∞–≤–Ω–∏–≤–∞–π —É—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –≤–∞–∫–∞–Ω—Å–∏–∏
- –í–æ–∑–≤—Ä–∞—â–∞–π –í–°–ï –≤–∞–∫–∞–Ω—Å–∏–∏ —Å score ‚â• 1
- –°–æ—Ä—Ç–∏—Ä—É–π —Å—Ç—Ä–æ–≥–æ –ø–æ —É–±—ã–≤–∞–Ω–∏—é score
- –î–ª—è –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏ –¥–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ï –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π

–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
{json.dumps(profile, ensure_ascii=False, indent=2)}

–°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π:
{json.dumps(jobs, ensure_ascii=False, indent=2)}

–û—Ç–≤–µ—Ç –≤–µ—Ä–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ score –æ—Ç 5 –¥–æ 1):
[
  {{
    "id": <id –≤–∞–∫–∞–Ω—Å–∏–∏>,
    "match_score": <—á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 5>,
    "reasons": [
      "–ù–∞–≤—ã–∫–∏: —Å–æ–≤–ø–∞–¥–∞—é—Ç Python, Django (–∏–∑ skills)",
      "–û–ø—ã—Ç: 3 –≥–æ–¥–∞ backend —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–∏–∑ experience)", 
      "–î–æ–ª–∂–Ω–æ—Å—Ç—å: –∏—â–µ—Ç Backend Developer, –≤–∞–∫–∞–Ω—Å–∏—è Python Developer",
      "–ì–æ—Ä–æ–¥: –∂–µ–ª–∞–µ—Ç –ê–ª–º–∞—Ç—ã, –≤–∞–∫–∞–Ω—Å–∏—è –≤ –ê–ª–º–∞—Ç—ã",
      "–£—Ä–æ–≤–µ–Ω—å: middle –æ–ø—ã—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è"
    ]
  }}, ...
]
"""
    try:
        response = client.chat.completions.create(
            model=DEPLOYMENT_NAME,
            messages=[
                {"role": "system", "content": "–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏ –ø–æ –ø—Ä–æ—Ñ–∏–ª—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON."},
                {"role": "user", "content": prompt},
            ],
            temperature=0.2,
            max_tokens=2000,
        )
        raw_text = response.choices[0].message.content
        print("üì• –û—Ç–≤–µ—Ç –æ—Ç Azure OpenAI (recommend):", raw_text)
        return json.loads(raw_text)
    except Exception as e:
        print("‚ùå Azure OpenAI API error (recommend):", e)
        raise HTTPException(status_code=500, detail="–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Azure OpenAI API (recommend)")

